@model List<WebBanDoTheThao.Models.SANPHAM>

@{
    ViewBag.Title = "Quần áo bóng đá";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isFavoriteDict = ViewBag.IsFavoriteDict as Dictionary<int, bool> ?? new Dictionary<int, bool>();
    var AllBrands = ViewBag.AllBrands as List<WebBanDoTheThao.Models.THUONGHIEU>;
    var SelectedBrandIDs = ViewBag.ThuongHieu as List<string>;

    // Ép kiểu các tham số lọc về danh sách (Nếu không nó sẽ bị lỗi Null Reference khi sử dụng trong filter-tag)
    var selectedMauSac = ViewBag.MauSac as List<string> ?? new List<string>();
    var selectedMucGia = ViewBag.MucGia as List<string> ?? new List<string>();
}
<link rel="stylesheet" href="@Url.Content("~/Assets/CSS/ShowSanPham.css?v=1.1")" />

<nav aria-label="breadcrumb" class="mt-3 py-1 px-3 rounded" style="background-color: #f8f9fa;">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"> <a href="~/Home/Index" class="text-decoration-none">Trang chủ</a> </li>
        <li class="breadcrumb-item"> <a href="/" class="text-decoration-none">Danh mục</a> </li>
        <li class="breadcrumb-item active text-dark" aria-current="page"> @ViewBag.Title </li>
    </ol>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-3 border-end pe-4">
            <h5 class="fw-bold
 mb-3">
                THƯƠNG HIỆU
            </h5>
            @if (AllBrands != null)
            {
                foreach (var th in AllBrands)
                {
                    string brandIdString = th.ID.ToString();
                    bool isChecked = SelectedBrandIDs != null && SelectedBrandIDs.Contains(brandIdString);
                    <div class="form-check mb-2">
                        <input class="form-check-input filter-brand" type="checkbox" value="@brandIdString"
                               id="brand_@brandIdString"
                               @(isChecked ? "checked" : "") />
                        <label class="form-check-label" for="brand_@brandIdString">@th.TENTH</label>
                    </div>
                }
            }

            <hr />

            <h5 class="fw-bold mb-3 mt-4">MÀU SẮC</h5>
            @foreach (var mau in ViewBag.DSMauSac as List<string>)
            {
                <div class="form-check mb-2">
                    <input class="form-check-input filter-color" type="checkbox" value="@mau"
                           id="color_@mau"
                           @(selectedMauSac.Contains(mau) ? "checked" : "") />
                    <label class="form-check-label" for="color_@mau">@mau</label>
                </div>
            }


            <hr />
            <h5 class="fw-bold mb-3 mt-4">MỨC GIÁ</h5>
            @{
                var mucGiaList = new List<Tuple<string, string>>()
                                        {

                        Tuple.Create("duoi100", "Giá dưới 100,000₫"),
                    Tuple.Create("100-200", "100,000₫ - 200,000₫"),
                    Tuple.Create("200-500", "200,000₫ - 500,000₫"),
                    Tuple.Create("500-700", "500,000₫ - 700,000₫"),

                    Tuple.Create("700-1000", "700,000₫ - 1,000,000₫"),
                    Tuple.Create("1000-2000", "1,000,000₫ - 2,000,000₫"),
                    Tuple.Create("tren3000", "Giá trên 3,000,000₫")
                };
            }

            @foreach (var muc in mucGiaList)
            {
                <div class="form-check mb-2">
                    <input class="form-check-input filter-price" type="checkbox" value="@muc.Item1"
                           id="price_@muc.Item1"
                           @(selectedMucGia.Contains(muc.Item1) ? "checked" : "") />
                    <label class="form-check-label" for="price_@muc.Item1">@muc.Item2</label>
                </div>
            }
        </div>

        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">@ViewBag.Title</h4>

                <div class="d-flex align-items-center">
                    <label for="sortSelect" class="me-2 fw-semibold text-muted">Sắp xếp:</label>
                    <select id="sortSelect"
                            class="form-select form-select-sm w-auto">
                        <option value="az" @(ViewBag.Sort == "az" ? "selected" : "")>
                            Tên A → Z
                        </option>
                        <option value="za" @(ViewBag.Sort == "za" ? "selected" : "")>Tên Z → A</option>
                        <option value="gia-tang" @(ViewBag.Sort == "gia-tang" ? "selected" : "")>Giá tăng dần</option>
                        <option value="gia-giam"
                                @(ViewBag.Sort == "gia-giam" ? "selected" : "")>
                            Giá giảm dần
                        </option>
                        <option value="hang-moi" @(ViewBag.Sort == "hang-moi" ? "selected" : "")>Hàng mới</option>
                    </select>
                </div>
            </div>


            <div id="filterTags" class="mb-3">
                @if (ViewBag.ThuongHieu != null)
                {
                    foreach (string thID in (List<string>)ViewBag.ThuongHieu)
                    {
                        // SỬA: Ép kiểu tường minh để so sánh ID (int) với thID (string)
                        string brandName = AllBrands.FirstOrDefault(t => t.ID.ToString() == thID)?.TENTH ?? thID;
                        <span class="badge bg-light text-primary border border-primary px-3 py-2 me-1 filter-tag" data-type="brand" data-id="@thID">@brandName ×</span>
                    }
                }
                @if (ViewBag.MauSac != null)
                {

                    foreach (string mau in selectedMauSac)
                    {
                        <span class="badge bg-light text-danger border border-danger px-3 py-2 me-1 filter-tag" data-type="color">@mau ×</span>
                    }
                }

                @if (ViewBag.MucGia != null)
                {
                    foreach (string mucGia in selectedMucGia)
                    {

                        string label = "";
                        string priceCode = mucGia;
                        switch (mucGia)
                        {
                            case "duoi100":
                                label = "Dưới 100,000₫";
                                break;
                            case "100-200": label = "100,000₫ - 200,000₫"; break;
                            case "200-500": label = "200,000₫ - 500,000₫"; break;
                            case "500-700": label = "500,000₫ - 700,000₫"; break;
                            case "700-1000": label = "700,000₫ - 1,000,000₫"; break;
                            case "1000-2000": label = "1,000,000₫ - 2,000,000₫"; break;
                            case "tren3000": label = "Trên 3,000,000₫"; break;
                        }
                        <span class="badge bg-light text-success border border-success px-3 py-2 me-1 filter-tag" data-type="price" data-price-code="@priceCode">@label ×</span>
                    }
                }
            </div>

            @if (Model != null
 && Model.Count() > 0)
            {
                <div class="row row-cols-2 row-cols-md-4 g-4">
                    @foreach (var sp in Model)
                    {
                        string detailUrl = Url.Action("ShowFullProduct", "Home", new { id = sp.ID });
                        bool isFav = isFavoriteDict.ContainsKey(sp.ID) && isFavoriteDict[sp.ID];
                        string iconClass = isFav ? "fas text-danger" : "far";
                        <div class="col-6 col-md-3">
                            <div class="card product-card border-0 shadow-sm h-75">
                                <div class="position-relative overflow-hidden">

                                    <a href="@detailUrl" class="d-block">
                                        <img src="~/Assets/Clothes_Images/@sp.AVATAR" class="card-img-top" alt="@sp.TENSP">
                                    </a>
                                    <div class="product-icons position-absolute top-50 start-50 translate-middle d-flex gap-2">
                                        <button class="btn btn-light btn-sm" onclick="location.href='@detailUrl'"><i class="fas fa-shopping-cart"></i></button>
                                        <button class="btn btn-light btn-sm quick-view-btn" data-masp="@sp.ID">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">

                                        <p class="text-muted text-uppercase small mb-0">
                                            @(sp.THUONGHIEU?.TENTH ?? "N/A")
                                        </p>
                                        <button type="button" class="btn btn-light btn-sm btn-fav" data-masp="@sp.ID">
                                            <i class="@iconClass fa-heart"></i>

                                        </button>
                                    </div>

                                    <h6 class="card-title">
                                        <a href="@detailUrl" class="text-dark text-decoration-none">@sp.TENSP</a>
                                    </h6>
                                    <p class="fw-bold text-danger mb-1">@sp.GIA.ToString("N0")₫</p>
                                </div>
                            </div>

                        </div>
                    }
                </div>
            }
            else
            {

                <div class="alert alert-info text-center mt-4">Không có sản phẩm nào phù hợp với bộ lọc.</div>
            }

            <div class="d-flex justify-content-center mt-4">
                @Html.Partial("_Pagination")
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickViewModalLabel">Xem Nhanh Sản Phẩm</h5>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="quickViewContent">
            </div>
        </div>
    </div>
</div>
<script>
    function buildQueryString(list, paramName) {
        return list.map(function (value) {
            return paramName + '=' + encodeURIComponent(value);
        }).join('&');
    }
</script>

@section Scripts {
    <script>
        $(document).ready(function() {
            function applyFilters() {
                var selectedBrands = [];
                $('.filter-brand:checked').each(function() {
                    selectedBrands.push($(this).val());

                });

                var selectedColors = [];
                $('.filter-color:checked').each(function() {
                    selectedColors.push($(this).val());
                });

                var selectedPrices = [];

                $('.filter-price:checked').each(function() {
                    selectedPrices.push($(this).val());
                });

                var sortOrder = $('#sortSelect').val();

                var brandQuery = buildQueryString(selectedBrands, 'thuonghieu');

                var colorQuery = buildQueryString(selectedColors, 'mausac');
                var priceQuery = buildQueryString(selectedPrices, 'mucgia');

                var params = [brandQuery, colorQuery, priceQuery];
                // Thêm page=1 để luôn reset về trang đầu khi áp dụng bộ lọc mới
                params.push('page=1');

                if (sortOrder) {
                    params.push('sort=' + sortOrder);
                }

                var queryString = params.filter(function(p) { return p.length > 0; }).join('&');
                var url = '@Url.Action("ShowQABD", "Home")' + (queryString ? '?' + queryString : '');

                window.location.href = url;
            }

            $('.filter-brand, .filter-color, .filter-price').change(applyFilters);
            $('#sortSelect').change(applyFilters);

            // Xử lý click tag (đã sửa lỗi trích dẫn)
            $(document).on('click', '.filter-tag', function() {
                var tag = $(this);
                var type = tag.data('type');

                if (type === 'brand') {
                    var brandId = tag.data('id');

                    $('.filter-brand[value="' + brandId + '"]').prop('checked', false);
                } else if (type === 'color') {
                    var value = tag.text().trim().slice(0, -1).trim();
                    $('.filter-color[value="' + value + '"]').prop('checked', false);
                }

                else if (type === 'price') {
                    var priceCode = tag.data('price-code');
                    $('.filter-price[value="' + priceCode + '"]').prop('checked', false);
                }

                applyFilters();

             });

            // Loại bỏ khối code JavaScript lặp lại và chỉ giữ lại một khối (chặn lỗi trùng lặp sự kiện)
            $(".btn-fav").off('click').on('click', function () {
                var button = $(this);
                var icon = button.find('i');
                var masp = button.data("masp");

                button.prop('disabled', true);

                $.post("@Url.Action("AddFavorite", "Home")", { masp: masp }, function
 (res) {
                    if (!res.success) {
                        alert(res.message || "Lỗi hệ thống không xác định.");
                        if (res.message && res.message.includes("đăng nhập")) {

                           window.location.href = "@Url.Action("Login", "Login")";
                        }
                    } else {
                        if (res.isFav) {

                           icon.removeClass("far").addClass("fas text-danger");
                        } else {
                            icon.removeClass("fas text-danger").addClass("far");
                        }

                           $("#fav-count").text(res.count);
 }
                }).fail(function() {
                    alert("Lỗi kết nối server (AJAX).");
                }).always(function() {
                    button.prop('disabled', false);
                });
            });

            $(document).on('click', '.quick-view-btn', function (e) {
                e.preventDefault();
                var masp = $(this).data('masp'); // Lấy ID sản phẩm
                var url = '@Url.Action("QuickView", "Home")';

                $.ajax({

                 url: url,
                    type: 'GET',
                    data: { id: masp }, // Truyền ID sản phẩm
                    beforeSend: function() {
                        // Hiển
                        $('#quickViewContent').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                    },
                    success: function (data) {
                        // Chèn
                        $('#quickViewContent').html(data);
                        // Hiển thị modal (Giả định bạn dùng Bootstrap 5)
                        var quickViewModal = new bootstrap.Modal(document.getElementById('quickViewModal'));
 quickViewModal.show();
                    },
                    error: function (xhr, status, error) {
                        var errorMessage = "Lỗi khi tải dữ liệu Quick View.";
 if (xhr.status == 404) {
                            errorMessage = "Sản phẩm không tồn tại.";
 }
                        $('#quickViewContent').html('<div class="alert alert-danger">' + errorMessage + '</div>');
 }
                });
            });

        });
    </script>
}